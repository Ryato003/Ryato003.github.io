<!DOCTYPE html>
<html lang="it" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu Settimanale App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Stili Base */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Rimossi stili .material-card e .material-summary specifici per il contenuto principale, non più usati qui */

        /* Stile per i riquadri dei pasti */
        .meal-box {
             padding: 1rem; /* p-4 */
             border-radius: 0.75rem; /* rounded-lg */
             box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); /* shadow-sm */
             /* Colore sfondo applicato dinamicamente */
        }
        .dark .meal-box {
             box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.3), 0 1px 1px -1px rgb(0 0 0 / 0.3); /* Ombra più scura */
        }

        .recipe-trigger { cursor: pointer; font-weight: 500; text-decoration: underline dotted; text-underline-offset: 3px; transition: color 0.15s ease-in-out, text-decoration-color 0.15s ease-in-out; }
        .recipe-trigger:hover { text-decoration: underline solid; }


        /* --- Stili Navigation Drawer - Material You Inspired --- */
        #sideNav { position: fixed; top: 0; left: 0; height: 100%; width: 300px; background-color: #FEFBFF; box-shadow: 0 8px 10px -5px rgb(0 0 0 / 0.2), 0 16px 24px 2px rgb(0 0 0 / 0.14), 0 6px 30px 5px rgb(0 0 0 / 0.12); transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 40; padding-top: 0; display: flex; flex-direction: column; overflow: hidden; }
        .dark #sideNav { background-color: #1B1C18; }
        #sideNav.open { transform: translateX(0); }
        #navHeader { padding: 1rem 1rem; margin-bottom: 0.5rem; flex-shrink: 0; border-bottom: 1px solid #E0E2D9; }
        .dark #navHeader { border-bottom-color: #454744; }
        #navHeader h2 { font-size: 1.125rem; font-weight: 500; color: #1B1C18; }
        .dark #navHeader h2 { color: #E4E2DE; }
        #navDynamicContent { flex-grow: 1; overflow-y: auto; padding: 0 0.75rem 1rem 0.75rem; }
        #navOverlay { position: fixed; inset: 0; z-index: 30; opacity: 0; transition: opacity 0.3s ease-in-out; pointer-events: none; background-color: rgba(0, 0, 0, 0.5); }
        .dark #navOverlay { background-color: rgba(0, 0, 0, 0.6); }
        #navOverlay.active { opacity: 1; pointer-events: auto; }
        #sideNav details { width: 100%; }
        #navDynamicContent > details:not(:first-child) { border-top: 1px solid #E0E2D9; margin-top: 0.5rem; padding-top: 0.5rem; }
        .dark #navDynamicContent > details:not(:first-child) { border-top-color: #454744; }
        #sideNav details summary.nav-summary { display: flex; align-items: center; position: relative; padding: 0.75rem 0.5rem; font-weight: 500; font-size: 0.9375rem; border-radius: 9999px; margin: 0; cursor: pointer; transition: background-color 0.15s ease-in-out; -webkit-tap-highlight-color: transparent; }
        #sideNav details summary.nav-summary:hover, #sideNav a.nav-link-day:hover { background-color: rgba(27, 28, 24, 0.08); }
        .dark #sideNav details summary.nav-summary:hover, .dark #sideNav a.nav-link-day:hover { background-color: rgba(228, 226, 222, 0.08); }
        #sideNav details summary.nav-summary:active, #sideNav a.nav-link-day:active:not(.active) { background-color: rgba(27, 28, 24, 0.12); }
        .dark #sideNav details summary.nav-summary:active, .dark #sideNav a.nav-link-day:active:not(.active) { background-color: rgba(228, 226, 222, 0.12); }
        #sideNav > details > summary.nav-summary-month { font-weight: 500; padding-top: 0.875rem; padding-bottom: 0.875rem; border-radius: 0; }
        #sideNav > details > summary.nav-summary-month svg { width: 24px; height: 24px; margin-right: 1rem; flex-shrink: 0; }
        /* Classi Colore Mesi */
        .nav-month-gennaio { color: #00668B; } .nav-month-gennaio svg { color: #0EA5E9; } .dark .nav-month-gennaio { color: #7DD3FC; } .dark .nav-month-gennaio svg { color: #38BDF8; }
        .nav-month-febbraio { color: #9D267A; } .nav-month-febbraio svg { color: #E879F9; } .dark .nav-month-febbraio { color: #F0ABFC; } .dark .nav-month-febbraio svg { color: #E879F9; }
        .nav-month-marzo { color: #65A30D; } .nav-month-marzo svg { color: #A3E635; } .dark .nav-month-marzo { color: #BEF264; } .dark .nav-month-marzo svg { color: #A3E635; }
        .nav-month-aprile { color: #0891B2; } .nav-month-aprile svg { color: #22D3EE; } .dark .nav-month-aprile { color: #67E8F9; } .dark .nav-month-aprile svg { color: #22D3EE; }
        .nav-month-maggio { color: #BE185D; } .nav-month-maggio svg { color: #F472B6; } .dark .nav-month-maggio { color: #F9A8D4; } .dark .nav-month-maggio svg { color: #F472B6; }
        .nav-month-giugno { color: #D97706; } .nav-month-giugno svg { color: #FBBF24; } .dark .nav-month-giugno { color: #FCD34D; } .dark .nav-month-giugno svg { color: #FBBF24; }
        .nav-month-luglio { color: #2563EB; } .nav-month-luglio svg { color: #60A5FA; } .dark .nav-month-luglio { color: #93C5FD; } .dark .nav-month-luglio svg { color: #60A5FA; }
        .nav-month-agosto { color: #EA580C; } .nav-month-agosto svg { color: #FB923C; } .dark .nav-month-agosto { color: #FDBA74; } .dark .nav-month-agosto svg { color: #FB923C; }
        .nav-month-settembre { color: #CA8A04; } .nav-month-settembre svg { color: #FACC15; } .dark .nav-month-settembre { color: #FDE047; } .dark .nav-month-settembre svg { color: #FACC15; }
        .nav-month-ottobre { color: #DC2626; } .nav-month-ottobre svg { color: #F87171; } .dark .nav-month-ottobre { color: #FCA5A5; } .dark .nav-month-ottobre svg { color: #F87171; }
        .nav-month-novembre { color: #78350F; } .nav-month-novembre svg { color: #D97706; } .dark .nav-month-novembre { color: #FCD34D; } .dark .nav-month-novembre svg { color: #FBBF24; }
        .nav-month-dicembre { color: #047857; } .nav-month-dicembre svg { color: #34D399; } .dark .nav-month-dicembre { color: #6EE7B7; } .dark .nav-month-dicembre svg { color: #34D399; }
        /* Fine Classi Colore Mesi */
        #sideNav details details summary.nav-summary { padding-left: 2.5rem; font-size: 0.875rem; color: #454744; }
        .dark #sideNav details details summary.nav-summary { color: #C8C6C1; }
        #sideNav a.nav-link-day { display: block; position: relative; padding: 0.75rem 0.5rem 0.75rem 3.5rem; font-size: 0.875rem; font-weight: 400; color: #454744; border-radius: 9999px; margin: 0.125rem 0; transition: background-color 0.15s ease-in-out, color 0.15s ease-in-out, font-weight 0.15s ease-in-out; text-decoration: none; overflow: hidden; }
        .dark #sideNav a.nav-link-day { color: #C8C6C1; }
        #sideNav a.nav-link-day.active { font-weight: 500; color: #001D36; background-color: #D0E4FF; }
        .dark #sideNav a.nav-link-day.active { color: #D0E4FF; background-color: #004A77; }
        #sideNav details > summary.nav-summary::after { content: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="%23757873" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>'); display: inline-block; width: 20px; height: 20px; margin-left: auto; transition: transform 0.2s ease-in-out; flex-shrink: 0; }
        .dark #sideNav details > summary.nav-summary::after { content: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="%238F918B" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>'); }
        #sideNav details[open] > summary.nav-summary::after { transform: rotate(180deg); }

        /* Stili Modal Procedimento (Invariati) */
        #procedureModal { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; z-index: 50; opacity: 0; transition: opacity 0.2s ease-in-out; pointer-events: none; padding: 1rem; background-color: rgba(0, 0, 0, 0.6); }
        .dark #procedureModal { background-color: rgba(0, 0, 0, 0.7); }
        #procedureModal.active { opacity: 1; pointer-events: auto; }
        .modal-content { padding: 1.75rem; border-radius: 1rem; box-shadow: 0 24px 38px 3px rgb(0 0 0 / 0.14), 0 9px 46px 8px rgb(0 0 0 / 0.12), 0 11px 15px -7px rgb(0 0 0 / 0.2); max-width: 95%; width: 500px; max-height: 85vh; overflow-y: auto; position: relative; transition: background-color 0.3s ease, transform 0.2s ease-out; transform: scale(0.95); }
        #procedureModal.active .modal-content { transform: scale(1); }
        .modal-close-btn { position: absolute; top: 0.75rem; right: 0.75rem; background: none; border: none; cursor: pointer; padding: 0.5rem; line-height: 1; z-index: 10; border-radius: 9999px; transition: background-color 0.15s ease-in-out, transform 0.1s ease-in-out, color 0.15s ease-in-out; }
        .modal-close-btn:hover { transform: scale(1.1); }
        .modal-close-btn:active { transform: scale(1); }
        .modal-close-btn svg { display: block; width: 20px; height: 20px; }
        #modalProcedureText ol { list-style: decimal; margin-left: 1.5rem; }
        #modalProcedureText li { padding-left: 0.5rem; margin-bottom: 0.625rem; line-height: 1.6; }
        #modalProcedureText li::marker { font-weight: 500; }

        /* Header sticky (Invariato) */
        header { transition: background-color 0.3s ease, border-color 0.3s ease; }
        .hidden-view { display: none; }
        .main-container { max-width: 896px; margin-left: auto; margin-right: auto; padding: 1rem; }
        @media (min-width: 640px) { .main-container { padding: 1.5rem; } }
        @media (min-width: 1024px) { .main-container { padding: 2rem; } }

        /* Stile per il messaggio placeholder */
        #menu-placeholder { text-align: center; padding: 4rem 1rem; font-size: 1.125rem; color: #757873; }
        .dark #menu-placeholder { color: #8F918B; }

        /* Stile per titolo menu dinamico */
        .menu-title { text-xl sm:text-2xl font-semibold text-slate-700 dark:text-slate-200 mb-6 flex items-center; }
        .menu-title svg { lucide lucide-calendar-check-2 mr-2 text-indigo-600 dark:text-indigo-400 h-6 w-6 sm:h-7 sm:w-7; }

    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-900 dark:text-slate-200">
    <header class="bg-white dark:bg-slate-800 shadow-sm sticky top-0 z-20 border-b border-slate-200 dark:border-slate-700">
        <div class="container mx-auto max-w-4xl px-4 h-16 flex items-center">
            <button id="menuBtn" class="p-2 mr-3 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 dark:ring-offset-slate-800 transition-colors duration-150">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-menu h-6 w-6 text-slate-700 dark:text-slate-300"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
            </button>
            <h1 class="text-xl font-semibold text-slate-800 dark:text-slate-100">Menu Settimanale</h1>
        </div>
    </header>

    <nav id="sideNav">
        <div id="navHeader"><h2>Navigazione Menu</h2></div>
        <div id="navDynamicContent"></div>
    </nav>

    <div id="navOverlay"></div>

    <div class="main-container mt-4">
        <div id="menu-view">
            <section id="menu" class="mb-12">
                <div id="menu-placeholder">
                    Seleziona una data dal menu laterale.
                </div>
            </section>
        </div>
    </div>

    <div id="procedureModal" class="hidden">
        <div id="modalContentDiv" class="modal-content relative bg-white dark:bg-slate-800">
            <button id="closeModalBtn" class="modal-close-btn text-slate-500 hover:bg-slate-100 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-100 dark:hover:bg-white/10" aria-label="Chiudi modale">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
            </button>
            <h3 id="modalTitle" class="text-lg font-semibold mb-4 text-slate-900 dark:text-slate-100">Procedimento</h3>
            <div id="modalProcedureText" class="text-sm text-slate-700 dark:text-slate-300"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOMContentLoaded fired.");

            // --- Selezione Elementi DOM ---
            const menuBtn = document.getElementById('menuBtn');
            const sideNav = document.getElementById('sideNav');
            const navOverlay = document.getElementById('navOverlay');
            const navDynamicContent = document.getElementById('navDynamicContent');
            const body = document.body;
            const menuView = document.getElementById('menu-view');
            const menuSection = document.getElementById('menu');
            const procedureModal = document.getElementById('procedureModal');
            const modalContentDiv = document.getElementById('modalContentDiv');
            const modalTitle = document.getElementById('modalTitle');
            const modalProcedureText = document.getElementById('modalProcedureText');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const mainContainer = document.querySelector('.main-container');

            // --- Dati Menu (Esempio Aprile - Settimana 2) ---
            const menuData = {
                "Aprile": {
                    "2": { // Settimana 2
                        "Lunedì": {
                            // dayTitle e summaryClasses non più usati da renderDayMenu
                            meals: [
                                { type: 'Colazione', icon: '🥛', text: '300ml Latte parzialmente scremato con 90g Biscotti secchi/ai cereali.', recipe: null },
                                { type: 'Pranzo', icon: '🍝', text: '150g Pasta integrale al pesto leggero di rucola con 150g Petto di pollo grigliato. Contorno abbondante di pomodori e insalata mista.', recipe: { title: 'Procedimento: Pesto Leggero di Rucola', procedure: "1. Metti nel mixer circa 30g di rucola.|2. Aggiungi 15g di frutta secca (noci o mandorle), 15g di Olio EVO, 1/2 spicchio d'aglio e 1 cucchiaino di succo di limone.|3. Aggiungi sale e pepe.|4. Frulla fino a ottenere una crema omogenea, aggiungendo 1-2 cucchiai d'acqua se necessario." } },
                                { type: 'Spuntino', icon: '🍎', text: '1 Mela + 170g Yogurt greco + 40g Gallette di riso/mais.', recipe: null },
                                { type: 'Cena', icon: '🐟', text: "200g Orata (o Merluzzo) all'acqua pazza, 300g Patate lesse o al vapore, asparagi al vapore.", recipe: { title: "Procedimento: Cottura all'Acqua Pazza", procedure: "1. Soffriggi 1 spicchio d'aglio in 1 cucchiaino (5ml) di Olio EVO in una padella capiente.|2. Aggiungi circa 70-80g di pomodorini tagliati a metà e 1 cucchiaio di prezzemolo tritato.|3. Versa circa 100-150ml d'acqua o brodo vegetale leggero e porta a leggero bollore.|4. Adagia i filetti di pesce (200g), regola di sale e pepe.|5. Copri e cuoci a fuoco basso per 10-15 minuti (a seconda dello spessore) finché il pesce è cotto e opaco." } },
                                { type: 'Spuntino pre nanna', icon: '🌙', text: "150g Fiocchi di latte + 10g Burro d'arachidi + 30g Gallette di riso/mais.", recipe: null }
                            ]
                        },
                        "Martedì": {
                             meals: [
                                { type: 'Colazione', icon: '🥛', text: '300ml Latte p.s. con 90g Biscotti secchi/ai cereali.', recipe: null },
                                { type: 'Pranzo', icon: '🍚', text: '150g Riso e Lenticchie. Contorno di carote crude + 100g Ricottine.', recipe: { title: 'Procedimento: Riso e Lenticchie', procedure: "1. Prepara un soffritto con circa 40g di cipolla tritata e 1 cucchiaino (5ml) di olio EVO.|2. Aggiungi 150g di lenticchie (già cotte o sciacquate se in scatola).|3. Aggiungi 150g di riso Basmati e tostalo leggermente per un minuto.|4. Copri con brodo vegetale caldo (circa 350-400ml).|5. Porta a cottura (circa 15-18 min) mescolando di tanto in tanto e aggiungendo altro brodo caldo se necessario.|6. Aggiusta di sale e aggiungi 1 rametto di rosmarino tritato a fine cottura." } },
                                { type: 'Spuntino', icon: '🥜', text: '1 Pera + 30g Frutta secca + 40g Gallette di riso/mais.', recipe: null },
                                { type: 'Cena', icon: '🦃', text: '200g Petto di tacchino saltato con funghi e cipolla, 130g Farro perlato, insalata mista.', recipe: { title: 'Procedimento: Petto di tacchino saltato con funghi', procedure: "1. Taglia 200g di petto di tacchino a striscioline o cubetti.|2. Affetta circa 80g di cipolla e 150g di funghi champignon.|3. Scalda 1-2 cucchiaini (5-10ml) di olio in una padella antiaderente e fai appassire la cipolla.|4. Aggiungi i funghi e cuoci finché l'acqua di vegetazione è evaporata.|5. Alza la fiamma, aggiungi il tacchino, sale, pepe.|6. Cuoci a fuoco vivace per 5-7 minuti, finché il tacchino è dorato e cotto internamente." } },
                                { type: 'Spuntino pre nanna', icon: '🌙', text: '1 misurino (30g) Proteine in polvere sciolte in 200ml acqua o Latte + 20g Frutta secca.', recipe: null }
                             ]
                        },
                         "Mercoledì": {
                             meals: [
                                { type: 'Colazione', icon: '🥛', text: '300ml Latte p.s. con 90g Biscotti secchi/ai cereali.', recipe: null },
                                { type: 'Pranzo', icon: '🐔', text: '180g Petto di pollo alla pizzaiola. Accompagnare con 100g Pane integrale e verdure grigliate (melanzane/zucchine).', recipe: { title: 'Procedimento: Cottura alla Pizzaiola', procedure: "1. Infarina leggermente (facoltativo) 180g di petto di pollo.|2. Rosola 1 spicchio d'aglio in 1 cucchiaino (5ml) di olio EVO.|3. Aggiungi il pollo e fallo dorare su entrambi i lati.|4. Aggiungi pomodori pelati spezzettati (circa 200g), 1 cucchiaino di origano secco, 1 cucchiaino di capperi dissalati (se usati), sale e pepe.|5. Copri e cuoci a fuoco basso per circa 15-20 minuti, finché il pollo è tenero e il sugo si è addensato." } },
                                { type: 'Spuntino', icon: '🍓', text: '1 Banana + 100g Ricottine con Cacao amaro.', recipe: null },
                                { type: 'Cena', icon: '🥩', text: 'Polpette leggere al sugo con 130g Orzo perlato e spinaci saltati con aglio.', recipe: { title: 'Procedimento: Polpette Leggere al Sugo', procedure: "1. Impasta 180g di macinato magro con 15g di pane grattugiato, 30g di albume, 1 cucchiaio di prezzemolo tritato, sale e pepe.|2. Forma delle polpette non troppo grandi.|3. Prepara un sugo semplice soffriggendo 40g di cipolla tritata (o aglio) in 1 cucchiaino (5ml) di olio, aggiungendo pomodori pelati (circa 250g) e sale.|4. Adagia delicatamente le polpette nel sugo caldo.|5. Copri e cuoci a fuoco basso per almeno 20-25 minuti, girandole a metà cottura." } },
                                { type: 'Spuntino pre nanna', icon: '🌙', text: '170g Yogurt greco + 40g Gallette di riso/mais + Miele (se gradito).', recipe: null }
                             ]
                        },
                         "Giovedì": {
                             meals: [
                                { type: 'Colazione', icon: '🥛', text: '300ml Latte p.s. con 90g Biscotti secchi/ai cereali.', recipe: null },
                                { type: 'Pranzo', icon: '🦐', text: '150g Riso integrale saltato con 150g Gamberetti e zucchine. Contorno di carote crude + 100g Formaggio spalmabile proteico.', recipe: { title: 'Procedimento: Riso saltato con Gamberetti e Zucchine', procedure: "1. Cuoci 150g di riso integrale.|2. Pulisci 150g di gamberetti.|3. Taglia una zucchina a julienne o piccoli cubetti.|4. Salta 1 spicchio d'aglio in 1-2 cucchiaini (5-10ml) di olio EVO.|5. Aggiungi i gamberetti e cuoci per 2-3 minuti finché cambiano colore.|6. Aggiungi le zucchine, sale, pepe, succo di limone e 1 cucchiaio di prezzemolo tritato.|7. Salta per un altro minuto, le zucchine devono rimanere croccanti.|8. Unisci il riso cotto e manteca bene." } },
                                { type: 'Spuntino', icon: '🍊', text: '1 Pera + 170g Yogurt greco + 30g Gallette di riso/mais.', recipe: null },
                                { type: 'Cena', icon: '🍗', text: '200g Pollo arrosto con rosmarino, 300g Patate al forno, zucchine grigliate.', recipe: { title: 'Procedimento: Pollo Arrosto con Rosmarino', procedure: "1. Prendi 200g di pollo (cosce senza pelle o petto).|2. Condiscilo con 1-2 cucchiaini (5-10ml) di Olio EVO, sale, pepe e 1-2 rametti di rosmarino tritato (e/o 1 spicchio d'aglio se gradito).|3. Disponilo su una teglia insieme a 300g di patate tagliate a spicchi e condite.|4. Cuoci in forno preriscaldato a 190-200°C per circa 30-45 minuti (a seconda della dimensione dei pezzi), finché il pollo è cotto e le patate sono tenere e dorate." } },
                                { type: 'Spuntino pre nanna', icon: '🌙', text: '150g Fiocchi di latte + 30g Frutta secca.', recipe: null }
                             ]
                        },
                         "Venerdì": {
                             meals: [
                                { type: 'Colazione', icon: '🥛', text: '300ml Latte p.s. con 90g Biscotti secchi/ai cereali.', recipe: null },
                                { type: 'Pranzo', icon: '🍲', text: 'Pasta e Lenticchie (100g pasta mista/ditalini). Servire con 50g Pane integrale.', recipe: { title: 'Procedimento: Pasta e Lenticchie', procedure: "1. Prepara un soffritto con circa 30g sedano, 30g carota, 40g cipolla tritati e 1 cucchiaino (5ml) di olio.|2. Aggiungi 150g di lenticchie (già cotte o sciacquate), i pomodori pelati (circa 150g) spezzettati e brodo vegetale fino a coprire.|3. Porta a cottura (o a bollore se lenticchie già cotte).|4. Butta 100g di pasta mista/ditalini direttamente nella pentola.|5. Cuoci insieme finché la pasta è cotta, aggiungendo brodo caldo q.b. per mantenere la zuppa cremosa. Regola di sale e pepe." } },
                                { type: 'Spuntino', icon: '🍊', text: '1 Banana + 170g Yogurt greco + 30g Gallette di riso/mais.', recipe: null },
                                { type: 'Cena', icon: '🍳', text: 'Frittata al forno con spinaci e 50g Ricotta. Contorno di insalata mista e 100g Pane integrale.', recipe: { title: 'Procedimento: Frittata al Forno Spinaci e Ricotta', procedure: "1. Cuoci (lessa o salta in padella) circa 150-200g di spinaci freschi e strizzali bene.|2. Sbatti 3 uova intere con 100g albumi in una ciotola.|3. Aggiungi gli spinaci tritati grossolanamente, 50g ricotta, sale, pepe e un pizzico di noce moscata (facoltativa).|4. Mescola bene il composto.|5. Versa in una piccola teglia (diametro ~18-20cm) rivestita di carta forno.|6. Cuoci in forno preriscaldato a 180°C per circa 20-25 minuti o finché la frittata è gonfia, soda e leggermente dorata." } },
                                { type: 'Spuntino pre nanna', icon: '🌙', text: "1 misurino (30g) Proteine in polvere + 10g Burro d'arachidi.", recipe: null }
                             ]
                        },
                         "Sabato": {
                             meals: [
                                { type: 'Colazione', icon: '🥛', text: '300ml Latte p.s. con 90g Biscotti secchi/ai cereali.', recipe: null },
                                { type: 'Pranzo', icon: '🍕', text: 'Pizza Margherita o con verdure (fatta in casa o da asporto).', recipe: null },
                                { type: 'Spuntino', icon: '🍌', text: '1 Pera + 150g Fiocchi di latte + 30g Gallette di riso/mais.', recipe: null },
                                { type: 'Cena', icon: '🍣', text: '180g Salmone alla griglia, 130g Riso Basmati, spinaci saltati con aglio e Olio EVO.', recipe: { title: 'Procedimento: Salmone Grigliato', procedure: "1. Scalda bene una griglia o una padella antiaderente.|2. Condisci 180g di filetto di salmone con sale, pepe, succo di limone e 1 cucchiaio di prezzemolo tritato (o aneto).|3. Cuoci sulla griglia calda per 3-5 minuti per lato (a seconda dello spessore e della cottura desiderata), iniziando dal lato della pelle se presente." } },
                                { type: 'Spuntino pre nanna', icon: '🌙', text: '170g Yogurt greco + 20g Frutta secca.', recipe: null }
                             ]
                        },
                         "Domenica": {
                             meals: [
                                { type: 'Colazione', icon: '🥛', text: '300ml Latte p.s. con 90g Biscotti secchi/ai cereali.', recipe: null },
                                { type: 'Pranzo', icon: '🍝', text: '150g Pasta integrale al ragù leggero. Contorno di insalata.', recipe: { title: 'Procedimento: Ragù Leggero', procedure: "1. Prepara un soffritto con 30g sedano, 30g carota, 40g cipolla tritati finemente e 1-2 cucchiaini (5-10ml) di olio EVO.|2. Aggiungi 150g di macinato magro (manzo o misto) e fallo rosolare bene sgranandolo.|3. Sfuma con 50ml di vino bianco o rosso (facoltativo) e lascia evaporare.|4. Aggiungi pomodori pelati (circa 300g) o passata, sale, pepe e una foglia d'alloro (facoltativo).|5. Copri e lascia sobbollire a fuoco basso per almeno 30-40 minuti, aggiungendo poca acqua calda o brodo q.b. se si asciuga troppo." } },
                                { type: 'Spuntino', icon: '🍐', text: '1 Mela + 100g Ricottine + 40g Gallette di riso/mais.', recipe: null },
                                { type: 'Cena', icon: '🍗', text: '200g Petto di pollo arrosto con erbe, 300g Patate al forno, melanzane al forno.', recipe: { title: 'Procedimento: Petto di Pollo Arrosto con Erbe', procedure: "1. Prendi 200g di petto di pollo.|2. Condiscilo massaggiandolo con 1-2 cucchiaini (5-10ml) di Olio EVO, sale, pepe e 1-2 cucchiai di erbe aromatiche tritate (rosmarino, salvia, timo...).|3. Disponilo su una teglia rivestita di carta forno insieme a 300g di patate e melanzane tagliate a pezzi e condite.|4. Cuoci in forno preriscaldato a 190°C per circa 25-30 minuti o finché il pollo è cotto internamente (non secco) e le verdure sono tenere e dorate." } },
                                { type: 'Spuntino pre nanna', icon: '🌙', text: "1 misurino (30g) Proteine sciolte in 200ml acqua o Latte + 10g Burro d'arachidi.", recipe: null }
                             ]
                        }
                    }
                }
            };


            // --- Dati Navigazione ---
            const mesi = ["Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno", "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"];
            const giorni = ["Lunedì", "Martedì", "Mercoledì", "Giovedì", "Venerdì", "Sabato", "Domenica"];
            const settimanePerMese = 4;

            // --- Placeholder Messages ---
            const placeholderTextDefault = "Seleziona una data dal menu laterale.";
            const placeholderTextNotAvailable = "Menu non disponibile per questa data. Seleziona un giorno nella Settimana 2 di Aprile per visualizzare l'esempio.";

            // --- Funzione per mostrare il placeholder ---
            function showPlaceholder(message = placeholderTextDefault) {
                 if (!menuSection) return;
                 const oldTitle = menuSection.querySelector('.menu-title');
                 if(oldTitle) oldTitle.remove();
                 menuSection.innerHTML = `<div id="menu-placeholder">${message}</div>`;
            }

            // --- Funzione per renderizzare i pasti di un giorno ---
            // Ritorna il contenitore dei pasti (un div)
            function renderDayMenu(dayData) {
                if (!dayData || !dayData.meals) return null; // Controllo aggiunto

                // Contenitore per i riquadri dei pasti
                const mealsContainer = document.createElement('div');
                mealsContainer.className = 'space-y-4'; // Spazio tra i riquadri

                dayData.meals.forEach(meal => {
                    // Crea un div per ogni pasto
                    const mealBox = document.createElement('div');
                    mealBox.className = 'meal-box'; // Applica stile base riquadro

                    // Determina e applica colore di sfondo
                    let mealColorClass = 'bg-gray-50 dark:bg-slate-700'; // Default
                    if (meal.type === 'Colazione') mealColorClass = 'bg-blue-50 dark:bg-slate-700/80';
                    else if (meal.type === 'Pranzo') mealColorClass = 'bg-green-50 dark:bg-slate-700/80';
                    else if (meal.type === 'Spuntino') mealColorClass = 'bg-yellow-50 dark:bg-slate-700/80';
                    else if (meal.type === 'Cena') mealColorClass = 'bg-red-50 dark:bg-slate-700/80';
                    else if (meal.type === 'Spuntino pre nanna') mealColorClass = 'bg-purple-50 dark:bg-slate-700/80';
                    mealBox.classList.add(...mealColorClass.split(' '));

                    // Costruisce HTML interno del riquadro
                    let mealHTML = `<strong class="block mb-1">${meal.icon || ''} ${meal.type}:</strong> ${meal.text}`;

                    if (meal.recipe && meal.recipe.title) { // Aggiunto controllo su title
                        const recipeTitleEscaped = meal.recipe.title.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
                        const regex = new RegExp(recipeTitleEscaped);
                        if (regex.test(mealHTML)) {
                             mealHTML = mealHTML.replace(regex,
                                `<span class="recipe-trigger text-blue-600 dark:text-indigo-400 hover:text-blue-700 dark:hover:text-indigo-300" data-title="${meal.recipe.title}" data-procedure="${meal.recipe.procedure || ''}">${meal.recipe.title}</span>`
                            );
                        } else {
                             mealHTML += ` (<span class="recipe-trigger text-blue-600 dark:text-indigo-400 hover:text-blue-700 dark:hover:text-indigo-300" data-title="${meal.recipe.title}" data-procedure="${meal.recipe.procedure || ''}">vedi ricetta</span>)`;
                        }
                    }
                    mealBox.innerHTML = mealHTML;
                    mealsContainer.appendChild(mealBox);
                });

                return mealsContainer; // Ritorna il contenitore con tutti i riquadri
            }


            // --- Funzione per Generare la Navigazione Dinamica ---
            function generaNavigazione() {
                 if (!navDynamicContent) { console.error("Elemento #navDynamicContent non trovato!"); return; }
                navDynamicContent.innerHTML = '';
                const calendarIconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar-days"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/><path d="M16 18h.01"/></svg>`;
                mesi.forEach(nomeMese => {
                    const meseDetails = document.createElement('details');
                    const meseSummary = document.createElement('summary');
                    const monthClass = 'nav-month-' + nomeMese.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                    meseSummary.classList.add('nav-summary', 'nav-summary-month', monthClass);
                    meseSummary.innerHTML = `${calendarIconSvg} ${nomeMese}`;
                    const settimaneContainer = document.createElement('div');
                    for (let i = 1; i <= settimanePerMese; i++) {
                        const settimanaDetails = document.createElement('details');
                        const settimanaSummary = document.createElement('summary');
                        settimanaSummary.classList.add('nav-summary');
                        settimanaSummary.textContent = `Settimana ${i}`;
                        const giorniContainer = document.createElement('div');
                        giorni.forEach(nomeGiorno => {
                            const giornoLink = document.createElement('a');
                            giornoLink.href = '#';
                            giornoLink.classList.add('nav-link-day');
                            giornoLink.dataset.giorno = nomeGiorno;
                            giornoLink.dataset.settimana = String(i);
                            giornoLink.dataset.mese = nomeMese;
                            giornoLink.textContent = nomeGiorno;
                            giorniContainer.appendChild(giornoLink);
                        });
                        settimanaDetails.appendChild(settimanaSummary);
                        settimanaDetails.appendChild(giorniContainer);
                        settimaneContainer.appendChild(settimanaDetails);
                    }
                    meseDetails.appendChild(meseSummary);
                    meseDetails.appendChild(settimaneContainer);
                    navDynamicContent.appendChild(meseDetails);
                });
                 console.log("Navigazione Material You con colori generata.");
            }

            // --- Genera la navigazione e mostra placeholder iniziale ---
            generaNavigazione();
            showPlaceholder();

            // --- Logica Apertura/Chiusura Navigazione Laterale ---
            function openNav() { sideNav.classList.add('open'); navOverlay.classList.add('active'); body.style.overflow = 'hidden'; }
            function closeNav() { sideNav.classList.remove('open'); navOverlay.classList.remove('active'); body.style.overflow = ''; }

            if (menuBtn) { menuBtn.addEventListener('click', (e) => { e.stopPropagation(); openNav(); }); }
            if (navOverlay) { navOverlay.addEventListener('click', closeNav); }

            // --- Gestione Click su Giorni Nav e Caricamento Contenuto ---
            if (sideNav) {
                sideNav.addEventListener('click', (e) => {
                    const linkCliccato = e.target.closest('a.nav-link-day');
                    if (linkCliccato) {
                        e.preventDefault();

                        const meseSelezionato = linkCliccato.dataset.mese;
                        const settimanaSelezionata = linkCliccato.dataset.settimana;
                        const giornoSelezionato = linkCliccato.dataset.giorno;

                        console.log(`Day link clicked: ${giornoSelezionato}, Sett ${settimanaSelezionata}, ${meseSelezionato}`);

                        // Aggiorna stato attivo nel nav
                        const activeLinks = sideNav.querySelectorAll('a.nav-link-day.active');
                        activeLinks.forEach(link => link.classList.remove('active'));
                        linkCliccato.classList.add('active');

                        // Carica contenuto nel main
                        if (menuSection) {
                            menuSection.innerHTML = ''; // Pulisce area contenuto

                            // Cerca i dati per il giorno selezionato
                            const dayData = menuData[meseSelezionato]?.[settimanaSelezionata]?.[giornoSelezionato];

                            if (dayData) {
                                // Crea e aggiunge il titolo H2
                                const titleElement = document.createElement('h2');
                                titleElement.className = 'menu-title text-xl sm:text-2xl font-semibold text-slate-700 dark:text-slate-200 mb-6 flex items-center';
                                titleElement.innerHTML = `
                                    <svg class="lucide lucide-calendar-check-2 mr-2 text-indigo-600 dark:text-indigo-400 h-6 w-6 sm:h-7 sm:w-7" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 14V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h8"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/><path d="m16 20 2 2 4-4"/></svg>
                                    <span>Piano per ${giornoSelezionato}, Sett. ${settimanaSelezionata}, ${meseSelezionato}</span>`;
                                menuSection.appendChild(titleElement);

                                // Renderizza e aggiunge il contenitore dei pasti
                                const mealsContainerElement = renderDayMenu(dayData); // Ora ritorna il div dei pasti
                                if (mealsContainerElement) {
                                    menuSection.appendChild(mealsContainerElement); // Aggiunge il div dei pasti
                                    console.log(`Menu per ${giornoSelezionato} caricato.`);
                                } else {
                                     showPlaceholder(placeholderTextNotAvailable); // Fallback
                                }
                            } else {
                                // Mostra messaggio "Non disponibile"
                                showPlaceholder(placeholderTextNotAvailable);
                                console.log("Menu non disponibile per la data selezionata.");
                            }
                        } else {
                            console.error("Elemento #menu non trovato!");
                        }

                        // Chiude il nav
                        closeNav();
                    }
                });
            }

            // --- Logica Modale Ricette ---
             function getModalStyling(triggerElement) {
                 // Cerca la card del pasto (.meal-box) o la card del giorno (.material-card) se la struttura cambia
                 const mealBox = triggerElement.closest('.meal-box');
                 const dayCard = triggerElement.closest('.material-card'); // Potrebbe non esserci più

                 let summarySource = null;
                 if (dayCard) { // Se c'è ancora la card giorno (improbabile con le modifiche)
                    summarySource = dayCard.querySelector('.material-summary');
                 } else if (mealBox) {
                    // Non c'è un summary associato direttamente al mealBox per derivare il colore
                    // Potremmo cercare il titolo H2 o usare colori default per la modale
                 }

                 // Colori Default Modale (se non si trova una fonte specifica)
                 let modalBgClass = 'bg-white dark:bg-slate-800';
                 let modalTextClass = 'text-slate-900 dark:text-slate-100';
                 let closeBtnClasses = ['text-slate-500', 'hover:bg-slate-100', 'hover:text-slate-700', 'dark:text-slate-400', 'dark:hover:text-slate-100', 'dark:hover:bg-white/10'];
                 let markerColorClass = 'marker:text-slate-500 dark:marker:text-slate-400';
                 const isDark = document.documentElement.classList.contains('dark');

                 // Logica per derivare colori dal summary (se presente) - Mantenuta per compatibilità
                 if (summarySource) {
                     const darkBgMatch = isDark ? Array.from(summarySource.classList).find(cls => cls.startsWith('dark:bg-')) : null;
                     const darkTextMatch = isDark ? Array.from(summarySource.classList).find(cls => cls.startsWith('dark:text-')) : null;
                     const lightBgMatch = !isDark ? Array.from(summarySource.classList).find(cls => cls.startsWith('bg-') && !cls.startsWith('dark:bg-')) : null;
                     const lightTextMatch = !isDark ? Array.from(summarySource.classList).find(cls => cls.startsWith('text-') && !cls.startsWith('dark:text-')) : null;

                     if (isDark) {
                         modalBgClass = darkBgMatch ? darkBgMatch.replace('dark:', '') : 'bg-slate-800';
                         modalTextClass = darkTextMatch ? darkTextMatch.replace('dark:', '') : 'text-slate-100';
                         const needsDarkIcon = modalTextClass.includes('white') || modalTextClass.includes('-100') || modalTextClass.includes('-200');
                         if (needsDarkIcon) {
                             closeBtnClasses = ['text-slate-300', 'hover:text-white', 'hover:bg-slate-600/50'];
                             markerColorClass = `marker:text-slate-400`;
                         } else {
                             closeBtnClasses = [`text-gray-700`, `hover:text-black`, `hover:bg-gray-300/50`];
                             markerColorClass = `marker:text-gray-600`;
                         }
                     } else {
                         modalBgClass = lightBgMatch || 'bg-white';
                         modalTextClass = lightTextMatch || 'text-slate-900';
                         const needsLightIcon = modalTextClass.includes('black') || modalTextClass.includes('-800') || modalTextClass.includes('-900');
                         if(needsLightIcon) {
                            closeBtnClasses = ['text-slate-600', 'hover:text-slate-900', 'hover:bg-black/10'];
                            markerColorClass = `marker:text-slate-600`;
                         } else {
                            closeBtnClasses = ['text-slate-500', 'hover:text-slate-700', 'hover:bg-black/5'];
                            markerColorClass = `marker:text-slate-500`;
                         }
                     }
                 }
                 // Assicura pulizia classi dark/light
                 if (!isDark) {
                    modalBgClass = modalBgClass.replace('dark:', '');
                    modalTextClass = modalTextClass.replace('dark:', '');
                    closeBtnClasses = closeBtnClasses.map(c => c.replace('dark:', ''));
                    markerColorClass = markerColorClass.replace('dark:', '');
                 } else {
                     modalBgClass = modalBgClass || 'bg-slate-800';
                     modalTextClass = modalTextClass || 'text-slate-100';
                     markerColorClass = markerColorClass || 'dark:marker:text-slate-400';
                 }
                 return { modalBgClass, modalTextClass, closeBtnClasses, markerColorClass };
             }
             function removeAllColorClasses(element) {
                 if (!element) return;
                 const prefixes = ['bg-', 'text-', 'border-', 'marker:text-', 'hover:bg-', 'hover:text-', 'dark:bg-', 'dark:text-', 'dark:border-', 'dark:marker:text-', 'dark:hover:bg-', 'dark:hover:text-'];
                 const classesToRemove = Array.from(element.classList).filter(cls => prefixes.some(prefix => cls.startsWith(prefix)));
                 element.classList.remove(...classesToRemove);
             }
             function openModal(title, procedure, styles) {
                  if (!modalTitle || !modalProcedureText || !modalContentDiv || !closeModalBtn || !procedureModal) { console.error("Modal elements not found!"); return; }
                 modalTitle.textContent = title || 'Procedimento';
                 const steps = procedure ? procedure.split('|') : [];
                 let procedureHtml = `<p>Procedimento non specificato.</p>`;
                 if (steps.length > 0 && steps[0].trim() !== '') {
                     procedureHtml = `<ol>`;
                     steps.forEach(step => { procedureHtml += `<li>${step.trim()}</li>`; });
                     procedureHtml += '</ol>';
                 }
                 modalProcedureText.innerHTML = procedureHtml;
                 removeAllColorClasses(modalContentDiv);
                 removeAllColorClasses(modalTitle);
                 removeAllColorClasses(modalProcedureText);
                 const listElement = modalProcedureText.querySelector('ol, p');
                 if (listElement) removeAllColorClasses(listElement);
                 removeAllColorClasses(closeModalBtn);
                 modalContentDiv.classList.add(styles.modalBgClass);
                 modalTitle.classList.add(styles.modalTextClass);
                 if (listElement) {
                    listElement.classList.add(styles.modalTextClass);
                    if(listElement.tagName === 'OL') listElement.classList.add(styles.markerColorClass);
                 }
                 closeModalBtn.classList.add(...styles.closeBtnClasses);
                 procedureModal.classList.remove('hidden');
                 void procedureModal.offsetWidth;
                 procedureModal.classList.add('active');
                 body.style.overflow = 'hidden';
             }
             function closeModal() {
                  if (!modalContentDiv || !modalTitle || !closeModalBtn || !procedureModal) return;
                  procedureModal.classList.remove('active');
                  setTimeout(() => {
                      procedureModal.classList.add('hidden');
                      body.style.overflow = '';
                  }, 200);
             }
             if (mainContainer) { // Listener per trigger ricette
                mainContainer.addEventListener('click', function(event) {
                    const trigger = event.target.closest('.recipe-trigger');
                    if (trigger) {
                        event.preventDefault();
                        const title = trigger.dataset.title;
                        const procedure = trigger.dataset.procedure;
                        const styles = getModalStyling(trigger);
                        openModal(title, procedure, styles);
                    }
                });
             }
             if (closeModalBtn) { closeModalBtn.addEventListener('click', closeModal); } // Chiusura modale
             if (procedureModal) {
                 procedureModal.addEventListener('click', function(event) { if (event.target === procedureModal) closeModal(); });
                 document.addEventListener('keydown', function(event) { if (event.key === 'Escape' && procedureModal.classList.contains('active')) closeModal(); });
             }

            console.log("DOMContentLoaded finished.");
        });
    </script>

</body>
</html>
